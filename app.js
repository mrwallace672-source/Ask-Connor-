/*  Ask Connor - NJTC Knowledge Base | FIXED VERSION */
const CONFIG={SHEET_ID:'1Mk_dsUSiAqF-dbLhzgbOppu4CqVIgOIxHbiiEnxjh2Y',PUBLISHED_ID:'2PACX-1vSdb5JPPXur2DPKofkB_EjGw0YD3Ia6kMZsM_U_PFOa0RQ2WaVmpEtDONfNWjkPRbesWSvq_7dVQ_QC',GID:'525529251',CONNOR_TIPS:{'i-Ready / Data':'ğŸ“Š <strong>Data-Driven Excellence:</strong> Color bands are your roadmap. Scholars in red domains need priority instruction!','PEARL / Attendance':'ğŸ“… <strong>Consistency = Impact:</strong> â‰¥90% attendance produces strongest outcomes. Log within 24 hours!','PEARL / Surveys':'ğŸ“ <strong>Your Voice Matters:</strong> Surveys drive coaching support. Aim for 4+ scores!','Program Expectations':'â­ <strong>Excellence:</strong> Quality = relationships + data + consistency!','Coaching / Growth':'ğŸŒ± <strong>Reflection = Results:</strong> Review data weekly. Use coaching to strengthen strategies!','Behavior Management':'ğŸ¤ <strong>Relationships First:</strong> Use proximity + positive reinforcement!','Engagement Strategies':'ğŸ® <strong>Fun + Structure:</strong> Games maximize engagement!','Instructional Differentiation':'ğŸ¯ <strong>Meet Them Where They Are:</strong> Assess gaps, reteach foundations!','default':'ğŸ‘‹ <strong>Welcome!</strong> I\'m Connor. High-impact tutoring = relationships + data + consistency!'}};const state={allData:[],categories:{},currentCategory:null,searchQuery:'',selectedSearchIndex:-1};const elements={searchInput:document.getElementById('searchInput'),clearSearch:document.getElementById('clearSearch'),searchResults:document.getElementById('searchResults'),categorySection:document.getElementById('categorySection'),categoryGrid:document.getElementById('categoryGrid'),questionsSection:document.getElementById('questionsSection'),categoryTitle:document.getElementById('categoryTitle'),questionChips:document.getElementById('questionChips'),backBtn:document.getElementById('backBtn'),resultsSection:document.getElementById('resultsSection'),resultsContainer:document.getElementById('resultsContainer'),loadingState:document.getElementById('loadingState'),emptyState:document.getElementById('emptyState'),refreshBtn:document.getElementById('refreshBtn'),connorTipText:document.getElementById('connorTipText'),connorTip:document.querySelector('.connor-tip')};async function fetchSheetData(){console.log('ğŸ” Fetching...');const strategies=[{name:'Direct CSV',url:`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/export?format=csv&gid=${CONFIG.GID}`,parser:'csv'},{name:'Direct GViz',url:`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?gid=${CONFIG.GID}&tqx=out:json`,parser:'gviz'},{name:'Published CSV',url:`https://docs.google.com/spreadsheets/d/e/${CONFIG.PUBLISHED_ID}/pub?output=csv&gid=${CONFIG.GID}`,parser:'csv'},{name:'Published GViz',url:`https://docs.google.com/spreadsheets/d/e/${CONFIG.PUBLISHED_ID}/gviz/tq?gid=${CONFIG.GID}&tqx=out:json`,parser:'gviz'}];for(const s of strategies){try{console.log(`ğŸ“¡ ${s.name}`);const r=await fetch(s.url,{method:'GET',mode:'cors',credentials:'omit',cache:'no-cache'});if(!r.ok)throw new Error(`HTTP ${r.status}`);const t=await r.text();if(!t||!t.trim())throw new Error('Empty');let d;if(s.parser==='gviz'){const m=t.match(/google\.visualization\.Query\.setResponse\((.*)\);?$/);if(!m)throw new Error('Invalid GViz');d=parseGVizData(JSON.parse(m[1]));}else{d=parseCSVData(t);}if(!d||d.length===0)throw new Error('No data');console.log(`âœ… ${s.name}: ${d.length} questions`);return d;}catch(e){console.warn(`âœ— ${s.name}: ${e.message}`);}}throw new Error('All methods failed');}function parseGVizData(data){const rows=data.table.rows;const cols=data.table.cols;const colMap={};cols.forEach((col,idx)=>{const label=(col.label||'').toLowerCase().replace(/[\/\s]/g,'');if(label.includes('category'))colMap.category=idx;else if(label.includes('question'))colMap.question=idx;else if(label.includes('response')||label.includes('summary'))colMap.summary=idx;else if(label.includes('next')&&label.includes('step'))colMap.nextSteps=idx;else if(label.includes('keyword'))colMap.keywords=idx;else if(label.includes('source')||label.includes('link'))colMap.source=idx;else if(label.includes('owner'))colMap.owner=idx;else if(label.includes('review'))colMap.lastReviewed=idx;else if(label.includes('tag'))colMap.tags=idx;});return rows.map(row=>{const c=row.c||[];return{category:(c[colMap.category]?.v||c[colMap.category]?.f||'').toString().trim(),question:(c[colMap.question]?.v||c[colMap.question]?.f||'').toString().trim(),summary:(c[colMap.summary]?.v||c[colMap.summary]?.f||'').toString().trim(),nextSteps:(c[colMap.nextSteps]?.v||c[colMap.nextSteps]?.f||'').toString().trim(),keywords:(c[colMap.keywords]?.v||c[colMap.keywords]?.f||'').toString().trim(),source:(c[colMap.source]?.v||c[colMap.source]?.f||'').toString().trim(),owner:(c[colMap.owner]?.v||c[colMap.owner]?.f||'').toString().trim(),lastReviewed:(c[colMap.lastReviewed]?.v||c[colMap.lastReviewed]?.f||'').toString().trim(),tags:(c[colMap.tags]?.v||c[colMap.tags]?.f||'').toString().trim()};}).filter(row=>row.category&&row.question);}function parseCSVData(csvText){const lines=csvText.split(/\r?\n/).filter(l=>l.trim());if(lines.length<2)throw new Error('No data rows');const headers=parseCSVLine(lines[0]);const headerMap={};headers.forEach((h,idx)=>{const hl=h.toLowerCase().replace(/[\/\s]/g,'');if(hl.includes('category'))headerMap.category=idx;else if(hl.includes('question'))headerMap.question=idx;else if(hl.includes('response')||hl.includes('summary'))headerMap.summary=idx;else if(hl.includes('next')&&hl.includes('step'))headerMap.nextSteps=idx;else if(hl.includes('keyword'))headerMap.keywords=idx;else if(hl.includes('source')||hl.includes('link'))headerMap.source=idx;else if(hl.includes('owner'))headerMap.owner=idx;else if(hl.includes('review'))headerMap.lastReviewed=idx;else if(hl.includes('tag'))headerMap.tags=idx;});const data=[];for(let i=1;i<lines.length;i++){try{const vals=parseCSVLine(lines[i]);const row={category:(vals[headerMap.category]||'').trim(),question:(vals[headerMap.question]||'').trim(),summary:(vals[headerMap.summary]||'').trim(),nextSteps:(vals[headerMap.nextSteps]||'').trim(),keywords:(vals[headerMap.keywords]||'').trim(),source:(vals[headerMap.source]||'').trim(),owner:(vals[headerMap.owner]||'').trim(),lastReviewed:(vals[headerMap.lastReviewed]||'').trim(),tags:(vals[headerMap.tags]||'').trim()};if(row.category&&row.question)data.push(row);}catch(e){console.warn(`Skip row ${i}: ${e.message}`);}}return data;}function parseCSVLine(line){const result=[];let current='',inQuotes=false;for(let i=0;i<line.length;i++){const char=line[i],next=line[i+1];if(char==='"'){if(inQuotes&&next==='"'){current+='"';i++;}else inQuotes=!inQuotes;}else if(char===','&&!inQuotes){result.push(current);current='';}else{current+=char;}}result.push(current);return result.map(v=>{let c=v.trim();if(c.startsWith('"')&&c.endsWith('"'))c=c.slice(1,-1);return c.replace(/""/g,'"');});}function processData(data){state.allData=data;state.categories={};data.forEach(item=>{const cat=item.category.trim();if(!state.categories[cat])state.categories[cat]=[];state.categories[cat].push(item);});const sorted={};Object.keys(state.categories).sort().forEach(k=>{sorted[k]=state.categories[k];});state.categories=sorted;console.log(`ğŸ“Š ${data.length} questions, ${Object.keys(state.categories).length} categories`);}function renderCategories(){const html=Object.entries(state.categories).map(([cat,items],idx)=>{const icon=cat.includes('/')?cat.split('/')[0].trim()[0].toUpperCase():cat[0].toUpperCase();return`<div class="category-card"data-category="${cat}"style="animation-delay:${idx*0.05}s"><div class="category-icon">${icon}</div><div class="category-name">${cat}</div><div class="category-count">${items.length} question${items.length!==1?'s':''}</div></div>`;}).join('');elements.categoryGrid.innerHTML=html;document.querySelectorAll('.category-card').forEach(c=>c.addEventListener('click',()=>showCategoryQuestions(c.dataset.category)));}function showCategoryQuestions(category){state.currentCategory=category;const questions=state.categories[category];elements.categorySection.style.display='none';elements.questionsSection.style.display='block';elements.categoryTitle.textContent=category;elements.resultsContainer.innerHTML='';const html=questions.map((item,idx)=>{const dataIndex=state.allData.indexOf(item);return`<button class="question-chip"data-index="${dataIndex}"style="animation-delay:${idx*0.04}s">${item.question}</button>`;}).join('');elements.questionChips.innerHTML=html;document.querySelectorAll('.question-chip').forEach(c=>c.addEventListener('click',()=>showResult([state.allData[parseInt(c.dataset.index)]])));updateConnorTip(category);window.scrollTo({top:0,behavior:'smooth'});}function showResult(results){if(results.length===0){elements.resultsContainer.innerHTML='';elements.emptyState.style.display='block';return;}elements.emptyState.style.display='none';const html=results.map((item,idx)=>{const nextSteps=parseNextSteps(item.nextSteps);const resources=parseResources(item.source);return`<div class="result-card"style="animation-delay:${idx*0.05}s"><div class="result-header"><span class="result-category-badge">${item.category}</span><h3 class="result-question">${item.question}</h3></div><div class="result-summary">${item.summary}</div>${nextSteps.length>0?`<div class="result-next-steps"><h4>âœ… Next Steps</h4><ul>${nextSteps.map(s=>`<li>${s}</li>`).join('')}</ul></div>`:''}${resources.length>0?`<div class="result-resources"><h4>ğŸ“š Resources & Links</h4><div class="resource-links">${resources.map(r=>`<a href="${r.url}"target="_blank"rel="noopener noreferrer"class="resource-link">${r.label}<svg viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10"y1="14"x2="21"y2="3"/></svg></a>`).join('')}</div></div>`:''}<div class="result-footer">${item.owner?`<span class="result-owner">ğŸ‘¤ ${item.owner}</span>`:''}${item.lastReviewed?`<span class="result-reviewed">ğŸ“… Updated ${item.lastReviewed}</span>`:''}</div></div>`;}).join('');elements.resultsContainer.innerHTML=html;setTimeout(()=>elements.resultsSection.scrollIntoView({behavior:'smooth'}),100);}function parseNextSteps(text){if(!text)return[];return text.split(/\n|â€¢|[-â€“â€”]/).map(s=>s.trim()).filter(s=>s.length>0);}function parseResources(text){if(!text)return[];const resources=[];text.split(/\n/).forEach(line=>{line=line.trim();if(!line)return;if(line.includes('|')){const[label,url]=line.split('|').map(s=>s.trim());if(url&&isValidUrl(url))resources.push({label:label||'Resource',url});}else if(isValidUrl(line)){resources.push({label:'View Resource',url:line});}});return resources;}function isValidUrl(str){try{const url=new URL(str);return url.protocol==='http:'||url.protocol==='https:';}catch{return false;}}function performSearch(query){if(!query||query.length<2){elements.searchResults.classList.remove('active');return;}const lq=query.toLowerCase();const results=state.allData.filter(i=>i.question.toLowerCase().includes(lq)||i.keywords.toLowerCase().includes(lq)||i.category.toLowerCase().includes(lq)||i.summary.toLowerCase().includes(lq)||i.tags.toLowerCase().includes(lq));renderSearchResults(results.slice(0,10));}function renderSearchResults(results){if(results.length===0){elements.searchResults.classList.remove('active');return;}const html=results.map(i=>`<div class="search-result-item"data-index="${state.allData.indexOf(i)}"><div class="search-result-question">${i.question}</div><div class="search-result-category">${i.category}</div></div>`).join('');elements.searchResults.innerHTML=html;elements.searchResults.classList.add('active');state.selectedSearchIndex=-1;document.querySelectorAll('.search-result-item').forEach(i=>i.addEventListener('click',()=>selectSearchResult(state.allData[parseInt(i.dataset.index)])));}function selectSearchResult(item){elements.searchInput.value=item.question;elements.searchResults.classList.remove('active');elements.clearSearch.style.display='flex';showResult([item]);updateConnorTip(item.category);}function handleSearchKeyboard(e){const results=document.querySelectorAll('.search-result-item');if(results.length===0)return;if(e.key==='ArrowDown'){e.preventDefault();state.selectedSearchIndex=Math.min(state.selectedSearchIndex+1,results.length-1);updateSearchSelection(results);}else if(e.key==='ArrowUp'){e.preventDefault();state.selectedSearchIndex=Math.max(state.selectedSearchIndex-1,-1);updateSearchSelection(results);}else if(e.key==='Enter'){e.preventDefault();const idx=state.selectedSearchIndex>=0?state.selectedSearchIndex:0;selectSearchResult(state.allData[parseInt(results[idx].dataset.index)]);}else if(e.key==='Escape'){elements.searchResults.classList.remove('active');}}function updateSearchSelection(results){results.forEach((r,idx)=>{if(idx===state.selectedSearchIndex){r.classList.add('selected');r.scrollIntoView({block:'nearest',behavior:'smooth'});}else{r.classList.remove('selected');}});}function updateConnorTip(category){const tip=CONFIG.CONNOR_TIPS[category]||CONFIG.CONNOR_TIPS.default;elements.connorTipText.innerHTML=tip;elements.connorTip.classList.remove('show');setTimeout(()=>elements.connorTip.classList.add('show'),100);}function initEventListeners(){elements.searchInput.addEventListener('input',e=>{const q=e.target.value.trim();if(q){elements.clearSearch.style.display='flex';performSearch(q);}else{elements.clearSearch.style.display='none';elements.searchResults.classList.remove('active');}});elements.searchInput.addEventListener('keydown',handleSearchKeyboard);elements.clearSearch.addEventListener('click',()=>{elements.searchInput.value='';elements.clearSearch.style.display='none';elements.searchResults.classList.remove('active');});document.addEventListener('click',e=>{if(!e.target.closest('.search-wrapper')&&!e.target.closest('.search-autocomplete')){elements.searchResults.classList.remove('active');}});elements.backBtn.addEventListener('click',()=>{state.currentCategory=null;elements.questionsSection.style.display='none';elements.categorySection.style.display='block';elements.resultsContainer.innerHTML='';elements.emptyState.style.display='none';updateConnorTip('default');window.scrollTo({top:0,behavior:'smooth'});});elements.refreshBtn.addEventListener('click',async()=>{elements.refreshBtn.disabled=true;elements.refreshBtn.style.opacity='0.6';await loadData();elements.refreshBtn.disabled=false;elements.refreshBtn.style.opacity='1';});document.querySelector('.connor-avatar').addEventListener('click',()=>elements.connorTip.classList.toggle('show'));}async function loadData(){try{elements.loadingState.style.display='block';elements.categorySection.style.display='none';elements.questionsSection.style.display='none';elements.emptyState.style.display='none';console.log('\nğŸš€ Ask Connor');const data=await fetchSheetData();processData(data);renderCategories();elements.loadingState.style.display='none';elements.categorySection.style.display='block';setTimeout(()=>elements.connorTip.classList.add('show'),1500);console.log('âœ… Loaded!\n');}catch(error){console.error('âŒ Failed:',error.message);elements.loadingState.innerHTML=`<div style="text-align:center;padding:3rem;max-width:700px;margin:0 auto"><svg width="100"height="100"viewBox="0 0 24 24"fill="none"stroke="#FF6B6B"stroke-width="2"><circle cx="12"cy="12"r="10"/><line x1="12"y1="8"x2="12"y2="12"/><line x1="12"y1="16"x2="12.01"y2="16"/></svg><h2 style="color:#FF6B6B;margin:1.5rem 0 1rem">Unable to Load Data</h2><p style="color:#5A6B7A;margin-bottom:2rem">Could not access sheet. Check browser console (F12) for details.</p><button onclick="location.reload()"style="padding:1rem 2rem;background:#003366;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">ğŸ”„ Try Again</button></div>`;}}function init(){console.log('ğŸ¯ Init');initEventListeners();loadData();}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
